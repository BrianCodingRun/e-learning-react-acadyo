name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            cd e-learning-react-acadyo

            echo "ğŸ”„ Mise Ã  jour du code source..."
            eval "$(ssh-agent -s)"
            git pull origin main

            echo "ğŸ›‘ ArrÃªt des anciens containers..."
            docker compose down

            echo "ğŸ§¹ Nettoyage des anciennes images..."
            docker system prune -f

            echo "ğŸš€ DÃ©marrage des nouveaux containers..."
            APP_ENV=prod docker compose up -d --build

            echo "â³ Attente du dÃ©marrage des services..."
            sleep 30

            echo "ğŸ” VÃ©rification du statut des containers..."
            docker compose ps

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"

  notify:
    runs-on: ubuntu-24.04
    needs: [deploy]
    if: always()

    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "âœ… DÃ©ploiement rÃ©ussi sur ${{ secrets.SERVER_HOST }}"
          else
              echo "âŒ Ã‰chec du dÃ©ploiement"
              exit 1
          fi
